name: Build Busybox
on:
  push:
     branches: [ main ]
     
jobs:
  build_busybox:
     runs-on: ubuntu-latest
     steps:
     - name: set ENV
       run: | 
         echo "NOW=$(date --rfc-3339=date)" >> "$GITHUB_ENV"
         echo "BR2_EXTERNAL=$GITHUB_WORKSPACE" >> "$GITHUB_ENV"

     - name: Checkout REPO
       uses: actions/checkout@v2
       with:
          submodules: recursive
          fetch-depth: '50'

     - name: Cache Dependencies
       uses: actions/cache@v2
       id: buildroot_cache
       with:
         path: /tmp/build
         key:  ${{ runner.os}}-make-${{ hashFiles('/tmp/build/build/*') }}

     - name: Load Menu config
       run: make O=/tmp/build -C ./buildroot container_busybox_defconfig

     - name: Download Source
       if: steps.cache.outputs.cache-hit != 'true'
       run: make O=/tmp/build -C ./buildroot source
        
     - name: Build Busybox RootFS
       run: |
         make O=/tmp/build -C ./buildroot all
         make O=/tmp/build -C ./buildroot external-deps  | egrep -v 'Entering directory|Leaving directory' | sort > /tmp/package-list 

     - name: Upload RootFS as Artifact
       uses: actions/upload-artifact@v2
       with:
          name: busybox_rootfs.${{ env.NOW }}.tgz
          path: /tmp/build/images/rootfs.tar.gz

     - name: Upload Package-List as Artifact
       uses: actions/upload-artifact@v2
       with:
          name: package-list
          path: /tmp/package-list

     - name: Create Docker Image
       run: |
         docker import /tmp/build/images/rootfs.tar.gz busybox
         docker tag busybox ghcr.io/opsmekanix/buysbox:${{ env.NOW }}

     - name: Push Docker Image
       run: |
         echo ${{ secrets.GITHUB_TOKEN }}  | docker login ghcr.io -u opsmekanix --password-stdin
         docker push ghcr.io/opsmekanix/buysbox:${{ env.NOW }}
